/**
 * This file is copyright 2017 State of the Netherlands (Ministry of Interior Affairs and Kingdom Relations).
 * It is made available under the terms of the GNU Affero General Public License, version 3 as published by the Free Software Foundation.
 * The project of which this file is part, may be found at https://github.com/MinBZK/operatieBRP.
 */

package nl.bzk.migratiebrp.synchronisatie.runtime;

import java.util.UUID;
import javax.jms.JMSException;
import nl.bzk.migratiebrp.synchronisatie.runtime.Main.Modus;
import org.junit.Assert;
import org.junit.Test;

public class SynchronisatieSyncNaarBrpIT extends AbstractIT {

    public SynchronisatieSyncNaarBrpIT() {
        super(Modus.SYNCHRONISATIE);
    }

    @Test
    public void test() throws InterruptedException, JMSException {
        final String content = maakSynchroniseerNaarBrpVerzoek(
                "01318011830110010637296208101200097819486170210008Leontien0240009Staartjes03100081966082103200040014033000460300410001V6110001E821000405188220008199409308230003PKA851000819920808861000819940930021500210006Minnie0240005Ienie03100081942083103200040013033000460300410001V621000819660821821000405188220008199409308230002PK851000819660821861000819940930031520210004Aart0240009Staartjes03100081938111803200040013033000460300410001M621000819660821821000405188220008199409308230002PK85100081966082186100081994093004086051000400016310003001821000405188220008199409308230002PK851000819660821861000819940930070776810008199409306910004051870100010801000400038020017201207011435010008710001P08235091000406260920008199806221010001W1030008199806221110010S vd Oyeln1115038Baron Schimmelpenninck van der Oyelaan11200021611600062252EB1170011Voorschoten11800160626010010016001119001606262000100160017210001T85100082011031686100082011031758126091000406260920008199806221010001W1030008199806221110010S vd Oyeln11200021611600062252EB7210001I85100081998062286100081998062458131091000405180920008199010021010001W1030008199512131110014Waldorpsstraat112000330411600062521CG7210001I85100081995121386100081995121458133091000405180920008199010021010001W1030008199010021110017Van Swietenstraat11200022011600062518EH7210001A851000819901002861000819940930");

        putMessage(SYNC_VERZOEK_QUEUE, content, UUID.randomUUID().toString());

        final String antwoord = getContent(expectMessage(SYNC_ANTWOORD_QUEUE));
        System.out.println(antwoord);
        Assert.assertTrue(antwoord.contains("<status>Toegevoegd</status>"));
    }

    @Test
    public void testNetjesAfvangenParseException() throws InterruptedException, JMSException {
        final String content = maakSynchroniseerNaarBrpVerzoek(
                "02812012210110010430898715401200099822430170210007Johanna0230007van "
                        + "den0240005Brink03100082000010103200040606033000460300410001V201001021067915706110001E821000406068220008201601028230015Dubbel "
                        + "A-nummer851000820160102861000820160102511810110010210679157001200099822430170210007Johanna0230007van "
                        + "den0240005Brink03100082000010103200040606033000460300410001V6110001E8110004060681200071 "
                        + "A1234851000820100101861000820100102511790110010210679157001200099822430170210005Sarah0230007van "
                        + "den0240005Brink03100082000010103200040606033000460300410001V6110001E8110004060681200071 "
                        + "A1234851000820100101861000820100102021960110010405304014601200092814677050210015Pieter Johannes0230007van "
                        + "den0240005Brink03100081970041103200040606033000460300410001M6210008200001018110004060681200071 "
                        + "B5678851000820100101861000820100102031800110010637947214601200092196100090210011Marie "
                        + "Maria0240007Bergsma03100081975081803200040772033000460300410001V6210008200001018110004077281200071 "
                        + "B5678851000820100101861000820100102031800110010637947214601200092196100090210011Marie "
                        + "Maria0240007Bergsma03100081975081803200040772033000460300410001V6210008200001018110004077281200071 "
                        + "B567885100082010010186100082010010204111051000400016310003027821000406068220008201401018230027Verkrijgen NL "
                        + "nationaliteit85100082014010186100082014010204082821000406068220008201601028230019Onterecht "
                        + "toegekend8510008201401018610008201505015411805100040223821000406068220008201401018230036Verkrijgen Amerikaanse "
                        +
                        "nationaliteit8410001O851000820140101861000820140102052080110010259298689801200095763107610210007Michael0240009Pietersen03100081975042003200041900033000460300410001M06100082015043006200040606063000460301510001H8110004060681200073 A1234851000820150430861000820150501061150810008205001010820004060608300046030821000406068220008205001018230015Overlijdensakte851000820500101861000820500101070776810008200001016910004060670100010801000400068020017201705011108350008710001P0809009100040606092000820170101131000460291320008201701017210001I85100082017010186100082017010258204091000406060920008200001011010001W1030008200001011110011Chopinplein1115009Chopinpln11200023511600063122VM1170008Schiedam11800160606011122334455119001606062011223344557210001.851000820000101861000820000102091560110010390816949001200093734621530210005Peter0240009Pietersen0310008201701010320007Berlijn033000460298110004199981200071 A3456851000820170101861000820170102091540110010826501761801200094309943700210006Dennis0240009Pietersen03100082015043003200040606033000460308110004060681200071 A234585100082015043086100082015050110054391000244393000820140101851000820140101861000820140102110393210002128510008201401018610008201401021209236100011821000406068220008201401018230021Reisdocument ongeldig851000820140101861000820140102130753810001A382000820200101821000406068220008201401018230019Kiesongerechtigheid");

        putMessage(SYNC_VERZOEK_QUEUE, content, UUID.randomUUID().toString());

        final String antwoord = getContent(expectMessage(SYNC_ANTWOORD_QUEUE));
        Assert.assertTrue(antwoord.contains("<status>Fout</status>"));
    }

    private String maakSynchroniseerNaarBrpVerzoek(final String inhoud) {
        final StringBuilder builder = new StringBuilder();
        builder.append("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>").append(System.lineSeparator());
        builder.append("<ns1:synchroniseerNaarBrpVerzoek xmlns:ns1=\"http://www.bzk.nl/migratiebrp/SYNC/0001\">").append(System.lineSeparator());
        builder.append("<ns1:verzendendeGemeente>062601</ns1:verzendendeGemeente>");
        builder.append("<ns1:lo3PersoonslijstAlsTeletexString>").append(inhoud).append("</ns1:lo3PersoonslijstAlsTeletexString>")
                .append(System.lineSeparator());
        builder.append("<ns1:typeBericht>").append("Lg01").append("</ns1:typeBericht>").append(System.lineSeparator());
        builder.append("</ns1:synchroniseerNaarBrpVerzoek>");

        return builder.toString();
    }
}
