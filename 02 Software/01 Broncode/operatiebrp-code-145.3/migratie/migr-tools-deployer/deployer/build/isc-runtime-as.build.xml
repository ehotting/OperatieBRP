<project name="ISC" basedir="." default="fail">

    <!--
     | Algemene properties
     |
     | server.host
     | server.host.node1
     | server.host.node2
     | server.username
     | server.password
     |
     | File properties
     |
     | application.source
     | application.file
     |
     | Runtime properties
     |
     | isc.database.host
     | isc.database.port
     | isc.database.name
     | isc.database.username
     | isc.database.password
     | activemq.url
     | jbpm.scheduler.autostart
     |
     | JMX properties
     |
     | isc.jmx.serialize.port
     |
    -->

    <property name="application.directory" value="isc" />

    <target name="checkProperties">
        <fail unless="server.host" message="server.host property is verplicht." />
        <fail unless="server.username" message="server.username property is verplicht." />
        <fail unless="server.password" message="server.password property is verplicht." />
    </target>

    <target name="checkInstallProperties" depends="checkProperties">
        <!-- Check file settings -->
        <fail unless="application.bin.source" message="application.bin.source property is verplicht bij het installeren." />
        <fail unless="application.bin.file" message="application.bin.file property is verplicht bij het installeren." />

        <!-- Check file(s) exist -->
        <fail message="${application.bin.source}/${application.bin.file} bestaat niet (of leidt niet tot exact 1 bestand).">
            <condition>
                <not>
                    <resourcecount count="1" >
                        <fileset dir="${application.bin.source}">
                            <include name="${application.bin.file}" />
                        </fileset>
                    </resourcecount>
                </not>
            </condition>
        </fail>

        <!-- Check configuration settings -->
        <fail unless="isc.database.host" message="isc.database.host property is verplicht." />
        <fail unless="isc.database.port" message="isc.database.port property is verplicht." />
        <fail unless="isc.database.name" message="isc.database.name property is verplicht." />
        <fail unless="isc.database.username" message="isc.database.username property is verplicht." />
        <fail unless="isc.database.password" message="isc.database.password property is verplicht." />
        <fail unless="activemq.url" message="activemq.url property is verplicht." />
        <fail unless="jbpm.scheduler.autostart" message="jbpm.scheduler.autostart property is verplicht." />
        <fail unless="isc.jmx.serialize.port" message="isc.jmx.serialize.port property is verplicht." />
    </target>

    <target name="install" depends="checkInstallProperties,createLocalConfigurationFiles">
        <echo message="Installing ${ant.project.name} ..." />

        <echo message="Setup temporary directory" />
        <sshexec host="${server.host}" username="${server.username}" password="${server.password}" trust="true"
                 command="cd /tmp; mkdir ${application.directory}; cd ${application.directory}; rm -rf *;" />

        <echo message="Copy ${application.bin.file}" />
        <scp todir="${server.username}:${server.password}@${server.host}:/tmp/${application.directory}" trust="true">
            <fileset dir="${application.bin.source}">
                <include name="${application.bin.file}" />
            </fileset>
        </scp>

        <echo message="Unpacking ${ant.project.name}" />
        <sshexec host="${server.host}" username="${server.username}" password="${server.password}" trust="true"
                 command="cd ~; mkdir ${application.directory}; cd ${application.directory}; unzip -o -q /tmp/${application.directory}/${application.bin.file} -d ." />

        <echo message="Remove default configuration" />
        <sshexec host="${server.host}" username="${server.username}" password="${server.password}" trust="true"
                 command="cd ~; cd ${application.directory}/conf; rm isc-runtime.properties; rm log4j2.xml" />

        <echo message="Making scripts executable" />
        <sshexec host="${server.host}" username="${server.username}" password="${server.password}" trust="true"
                 command="chmod u+x ~/${application.directory}/*.sh" />

        <scp todir="${server.username}:${server.password}@${server.host}:~/${application.directory}/conf/" trust="true" >
            <fileset dir="tmp">
                <include name="isc-runtime.properties" />
            </fileset>
        </scp>

        <scp todir="${server.username}:${server.password}@${server.host}:~/${application.directory}/conf/" trust="true" >
            <fileset dir="deps/algemeen">
                <include name="log4j2.xml" />
            </fileset>
        </scp>

        <echo message="Succesfully installed ${ant.project.name}" />
    </target>



    <target name="createLocalConfigurationFiles" depends="checkInstallProperties">
        <echo message="Creating configuration files for ${ant.project.name} ..." />
        <delete dir="tmp" />
        <mkdir dir="tmp" />

        <echo file="tmp/isc-runtime.properties">routering.activemq.url=${activemq.url}

jbpm.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

jbpm.scheduler.autostart=true
jbpm.scheduler.instanceid=AUTO
jbpm.scheduler.idlewaittime=1000
jbpm.scheduler.driver=org.quartz.impl.jdbcjobstore.PostgreSQLDelegate
jbpm.scheduler.threads=10

isc.database.nonxa.driver=org.postgresql.Driver
isc.database.nonxa.url=jdbc:postgresql://${isc.database.host}:${isc.database.port}/${isc.database.name}
isc.database.nonxa.minpool=1
isc.database.nonxa.maxpool=10

isc.database.driver=org.postgresql.xa.PGXADataSource
isc.database.host=${isc.database.host}
isc.database.port=${isc.database.port}
isc.database.name=${isc.database.name}
isc.database.username=${isc.database.username}
isc.database.password=${isc.database.password}
isc.database.minpool=1
isc.database.maxpool=80

isc.queue.sync.antwoord=sync.antwoord
isc.queue.sync.verzoek=sync.verzoek
isc.queue.voisc.ontvangst=voisc.ontvangst
isc.queue.voisc.verzenden=voisc.verzenden
isc.queue.levering=levering
isc.topic.gemeente=gemeente.register
isc.queue.gemeente=gemeente.verzoek
isc.topic.afnemer=afnemer.register
isc.queue.afnemer=afnemer.verzoek

isc.jmx.serialize.port=${isc.jmx.serialize.port}

atomikos.max.timeout=300
atomikos.default.timeout=10
atomikos.max.actives=100
atomikos.unique.name=isc-runtime
atomikos.base.dir=work/atomikos

isc.levering.autostart=${jbpm.scheduler.autostart}
isc.levering.minconsumers=1
isc.levering.maxconsumers=10

isc.sync.autostart=${jbpm.scheduler.autostart}
isc.sync.minconsumers=1
isc.sync.maxconsumers=10

isc.voisc.autostart=${jbpm.scheduler.autostart}
isc.voisc.minconsumers=1
isc.voisc.maxconsumers=10

registerclient.afnemer.autostart=true
registerclient.partij.autostart=true
        </echo>

    </target>

    <target name="deinstall" depends="checkProperties">
        <echo message="Removing ${ant.project.name}  ..." />
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}"
                 command="cd ~; rm -Rf ${application.directory}" />

        <echo message="Succesfully removed ${ant.project.name}" />
    </target>

    <target name="start" depends="checkProperties">
        <echo message="Starting ${ant.project.name}" />
        <sshexec host="${server.host}" username="${server.username}" password="${server.password}" trust="true"
                 command="cd ~; cd ${application.directory}; ./runIsc.sh > output.txt &amp;" />

        <java classname="nl.bzk.migratiebrp.tools.controle.waiter.IscInitializationWaiter" failonerror="true">
            <arg line="${waiter.arguments}"/>
            <sysproperty key="jmx.service.url" value="service:jmx:simple://${server.host}:${isc.jmx.serialize.port}"/>
            <sysproperty key="jmx.service.username" value="admin"/>
            <sysproperty key="jmx.service.password" value="admin"/>
        </java>

        <echo message="Succesfully started ${ant.project.name}" />
    </target>

    <target name="stop" depends="checkProperties">
        <echo message="Stopping ${ant.project.name} (and sleeping 15s)" />
        <sshexec host="${server.host}" username="${server.username}" password="${server.password}" trust="true" failonerror="false"
                 command="cd ~; cd ${application.directory}; ./stopIsc.sh ; sleep 15s; tail -n 100 ../output.txt" />

        <echo message="Succesfully stopped ${ant.project.name}" />
    </target>

    <target name="clean" depends="checkProperties">
    </target>

    <target name="fail">
        <fail message="Call with valid task" />
    </target>

</project>
