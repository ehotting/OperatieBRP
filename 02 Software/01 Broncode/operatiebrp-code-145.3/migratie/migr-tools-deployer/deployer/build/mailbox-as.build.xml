<project name="Mailbox simulator" basedir="." default="fail">

    <!--
     | Algemene properties
     |
     | server.host
     | server.username
     | server.password
     |
     | File properties
     |
     | application.source
     | application.file
     | 
     | Mailbox properties 
     |
     | mailbox.port
     |
     | JMX properties
     |
     | mailbox.jmx.serialize.port
    -->
    
    <property name="application.directory" value="mailbox" />

    <target name="checkProperties">
        <fail unless="server.host" message="server.host property is verplicht." />
        <fail unless="server.username" message="server.username property is verplicht." />
        <fail unless="server.password" message="server.password property is verplicht." />
    </target>
    

    <target name="checkInstallProperties" depends="checkProperties">
        <!-- Check file settings -->
        <fail unless="application.source" message="application.source property is verplicht bij het installeren." />
        <fail unless="application.file" message="application.file property is verplicht bij het installeren." />
        
        <fail unless="mailbox.port" message="mailbox.port property is verplicht bij het installeren." />
        <fail unless="mailbox.factory.type" message="mailbox.factory.type property is verplicht bij het installeren." />
        
        <fail unless="mailbox.database.url" message="mailbox.database.url property is verplicht bij het installeren." />
        <fail unless="mailbox.database.username" message="mailbox.database.username property is verplicht bij het installeren." />
        
        <fail unless="mailbox.database.password" message="mailbox.database.password property is verplicht bij het installeren." />
        <fail unless="mailbox.jmx.serialize.port" message="mailbox.jmx.serialize.port property is verplicht bij het installeren." />

        <!-- Check file exists -->
        <fail message="${application.source}/${application.file} bestaat niet (of leidt niet tot exact 1 bestand).">
            <condition>
                <not>
                    <resourcecount count="1" >
                        <fileset dir="${application.source}">
                            <include name="${application.file}" />
                        </fileset>
                    </resourcecount>
                </not>
            </condition>
        </fail>
    </target>
        

    <target name="install" depends="checkInstallProperties">
        <echo message="Copying ${ant.project.name}" />
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" 
                 command="cd /tmp; mkdir ${application.directory}; cd ${application.directory}; rm -rf *;" />
        
        <scp todir="${server.username}:${server.password}@${server.host}:/tmp/${application.directory}" trust="true" failonerror="true">
            <fileset dir="${application.source}">
                <include name="${application.file}" />
            </fileset>
        </scp>

        <echo message="Unpacking ${ant.project.name}" />
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" 
                 command="cd ~; mkdir ${application.directory}; cd ${application.directory}; unzip -o /tmp/${application.directory}/${application.file} -d .; chmod u+x *.sh" />

        <echo message="Creating configuration ${ant.project.name}" />
        <delete dir="tmp" />
        <mkdir dir="tmp" />
        <echo file="tmp/tools-mailbox.properties" append="false" force="true">
#
# Mailbox
#
mailbox.port=${mailbox.port}
mailbox.factory.type=${mailbox.factory.type}
mailbox.database.url=${mailbox.database.url}
mailbox.database.username=${mailbox.database.username}
mailbox.database.password=${mailbox.database.password}

#
# JMX
#
mailbox.jmx.serialize.port=${mailbox.jmx.serialize.port}
        </echo>
        
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}"
                 command="cd ~; cd ${application.directory}/conf; rm tools-mailbox.properties; rm log4j2.xml" />

        <scp todir="${server.username}:${server.password}@${server.host}:~/${application.directory}/conf/" trust="true" failonerror="true">
            <fileset dir="tmp">
                <include name="tools-mailbox.properties" />
            </fileset>
        </scp>

        <scp todir="${server.username}:${server.password}@${server.host}:~/${application.directory}/conf/" trust="true" >
            <fileset dir="deps/algemeen">
                <include name="log4j2.xml" />
            </fileset>
        </scp>

        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" 
                 command="cd ~; cd ${application.directory}/conf; chmod 600 tools-mailbox.properties; chmod 600 log4j2.xml" />
        
    </target>

    <target name="deinstall" depends="checkProperties">
        <echo message="Removing ${ant.project.name}" />
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" 
                 command="cd ~; rm -Rf ${application.directory}" />

        <echo message="Succesfully removed ${ant.project.name}" />
    </target>
    
    <target name="start" depends="checkProperties">
        <echo message="Starting ${ant.project.name}" />
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" 
                 command="cd ~; cd ${application.directory}; ./runMailbox.sh" />

        <java classname="nl.bzk.migratiebrp.tools.controle.waiter.MailboxInitializationWaiter" failonerror="true">
            <arg line="${waiter.arguments}"/>
            <sysproperty key="jmx.service.url" value="service:jmx:simple://${server.host}:${mailbox.jmx.serialize.port}"/>
            <sysproperty key="jmx.service.username" value="admin"/>
            <sysproperty key="jmx.service.password" value="admin"/>
        </java>

        <echo message="Succesfully started ${ant.project.name}" />
    </target>

    <target name="stop" depends="checkProperties">
        <echo message="Stopping ${ant.project.name} (and sleeping 15s)" />
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" failonerror="false" 
                 command="cd ~; cd ${application.directory}; ./stopMailbox.sh; sleep 15s; tail -n 100 output.txt" />

        <echo message="Succesfully stopped ${ant.project.name}" />
    </target>

    <target name="clean" depends="checkProperties">
        <sshexec host="${server.host}" trust="true" username="${server.username}" password="${server.password}" 
                 command="cd ~; cd ${application.directory}; rm -Rf data" />
    </target>

    <target name="fail">
        <fail message="Call with valid task" />
    </target>
    
</project>